{% extends "admin-page.property.njk.html" %}

{% block bodyEnd %}
{{ super() }}

<style>
.conditions-block .conditions-block {
  border: solid 2px #000;
  padding: 1rem;
}
</style>
<script>

//(() => {

  const booleanConditional = document.querySelector('.booleanConditionalOptions')
  if (!booleanConditional) {
    //return
  }
  let allowableOperators
  let allowableIdentifiers

  const getOperator = (operatorName) => {
    return allowableOperators.filter(operator => operator.operator === operatorName)[0] || {}
  }
  const getOperatorProperty = (operatorName, property) => getOperator(operatorName)[property]
  const getIdentifier = (identifierName) => {
    return allowableIdentifiers.filter(identifier => identifier.name === identifierName)[0] || {}
  }
  const getIdentifierProperty = (identifierName, property) => getIdentifier(identifierName)[property]

  const createSelect = (name, values, selectedValue) => {
    let selectElement = `<select name="${name}" class="govuk-select" style="width:auto; min-width: 10rem; display:block;margin-bottom: 0.5rem;"><option value=""></option>`
    values.forEach(item => {
      selectElement += `<option value="${item.value}"${ selectedValue === item.value ? ' selected' : ''}>${item.label}</option>`
    })
    selectElement += '<select>'
    return selectElement
  }

  const createIdentifier = (condition, conditionId) => {
    const {identifier} = condition
    const values = allowableIdentifiers.map(item => {
      return {
        value: item.name,
        label: item.fullTitle
      }
    })
    let identifierElement = createSelect(`identifier===${conditionId}`, values, identifier)
    return identifierElement
  }

  const asIsOperators = [
    'boolean',
    'date',
    'number'
  ]
  const createOperator = (condition, conditionId) => {
    let {identifier, operator, type, negated, enums} = condition
    if (!identifier) {
      return ''
    }
    if (negated) {
      operator = `!${operator}`
    }
    type = getIdentifierProperty(identifier, 'type')
    if (!asIsOperators.includes(type)) {
      type = 'string'
    }
    const operators = allowableOperators.filter(operator => {
      if (!operator.type) {
        return true
      }
      let enumsMatch = true
      if (enums) {
        enumsMatch = operator.operator === 'is' || operator.operator === 'equals' || operator.operator === 'defined'
      }
      let typeMatch = operator.type === 'any' || operator.type === type
      return typeMatch && enumsMatch
    })
    let operatorElement = createSelect(`operator===${conditionId}`, operators, operator)
    return operatorElement
  }

  const createValue = (condition, conditionId) => {
    let {identifier, operator, value, enums} = condition
    if (!operator || operator === 'defined' || operator === 'isTrue') {
      return ''
    }
    let valueElement
    let valueName = `value===${conditionId}`
    if (enums) {
     valueElement = createSelect(valueName, enums, value)
    } else {
      valueElement = `<input type="text" name="${valueName}" value="${value === undefined ? '' : value}" class="govuk-input" style="width:10em;">`
    }
    return valueElement
  }

  const createAnswer = (condition) => {
    const {identifier} = condition
    let answerElement = identifier.endsWith('[*]') ? 'any answer for' : 'the answer for'
    return answerElement
  }

  const createConditions = (conditions, conditionId = '', type, str) => {
    let conditionsId = conditionId ? conditionId + '.' : ''
    conditionsId += type
    let conditionIdCounter = 0
    const conditionParts = conditions.map(condition => {
      const newConditionId = `${conditionsId}[${conditionIdCounter}]`
      conditionIdCounter++
      return createCondition(condition, newConditionId)
    })
    return '<div class="conditions-block">' + str + '<br>' + conditionParts.join('') + '</div>'
  }

  const createCondition = (condition, conditionId = '') => {
    if (typeof condition !== 'object') {
      return ''
    }
    condition = JSON.parse(JSON.stringify(condition))
    const {all, any, exactly} = condition
    if (all) {
      const conditions = createConditions(all, conditionId, 'all', 'All these must be met')
      return  conditions
    }
    if (any) {
      const conditions = createConditions(any, conditionId, 'any', 'At least one of these must be met')
      return conditions
    }
    if (exactly) {
      const conditions = createConditions(exactly, conditionId, 'exactly', 'One of these must be met')
      return conditions
    }
    console.log('conditionId', conditionId)
    const {identifier, operator, value, negated} = condition
    const enums = allowableIdentifiers.filter(item => item.name === identifier).map(item => item.enums)[0]
    condition.enums = enums
    if (identifier !== undefined) {
      return `<p class="condition-individual">${createAnswer(condition)} ${createIdentifier(condition, conditionId)} ${createOperator(condition, conditionId)} ${createValue(condition, conditionId)}</p>`
    } else {
      
    }
  }

  // const valueGroup = document.querySelector('[data-block-id="admin.instance.property--value"]')
  // valueGroup.classList.add('js-hidden')

  booleanConditional.insertAdjacentHTML('afterend', '<div id="conditions"></div><p id="conditionsToggle"></p>')

  const conditionContainer = document.querySelector('#conditions')
  const conditionsToggler = document.querySelector('#conditionsToggle')


  let valueControl

  let jsonMode = false
  let uiImpossible = false

  const updateConditions = (condition) => {
    const renderedCondition = createCondition(condition)
    if (renderedCondition !== undefined) {
      uiImpossible = false
      conditionContainer.innerHTML = renderedCondition
      showJSONMode(jsonMode)
    } else {
      uiImpossible = true
      showJSONMode(true)
    }
  }
  const showJSONMode = (showJSON) => {
    jsonMode = !!showJSON
    let uiDisplay = ''
    let jsonDisplay = 'none'
    let toggleLabel = 'Show JSON'
    if (showJSON) {
      uiDisplay = 'none'
      jsonDisplay = ''
      toggleLabel = 'Show GUI'
    }
    if (uiImpossible) {
      toggleLabel = 'Cannot show JSON structure through UI'
    }
    conditionContainer.style.display = uiDisplay
    valueControl.style.display = jsonDisplay
    conditionsToggler.innerHTML = toggleLabel
  }
  conditionsToggler.addEventListener('click', () => {
    if (uiImpossible) {
      return
    }
    showJSONMode(!jsonMode)
  })

  conditionContainer.addEventListener('change', function(e) {
    const target = e.target
    let targetValue = target.value
    let [name, destination] = target.name.split('===')
    console.log({destination})
    const valueDestination = value
    if (name === 'identifier') {
      delete value.operator
      delete value.value
    } else if (name === 'operator') {
      if (targetValue.startsWith('!')) {
        targetValue = targetValue.substr(1)
        valueDestination.negated = true
      } else {
        delete valueDestination.negated
      }
      if (targetValue === 'defined' || targetValue === 'isTrue') {
        delete valueDestination.value
      }
    }
    if (name === 'value' && targetValue !== '') {
      let valueType = getOperatorProperty(value.operator, 'type')
      //allowableOperators.filter(operator => operator.operator === value.operator)[0].type
      if (valueType === 'number') {
        let numberValue = Number(targetValue)
        if (!isNaN(numberValue)) {
          targetValue = numberValue
        }
      }
    }
    valueDestination[name] = targetValue
    updateValueControl('condition')
    updateConditions(value)
  })

  const formElements = document.forms[0].elements

  allowableIdentifiers = JSON.parse(unescape(formElements.booleanConditional.value))

  const allowableOperatorsIn = JSON.parse(unescape(formElements.allowableOperators.value))
  allowableOperators = []
  Object.keys(allowableOperatorsIn).forEach(key => {
    const operatorValues = allowableOperatorsIn[key]
    const type = operatorValues.type
    allowableOperators.push({
      operator: key,
      type,
      value: key,
      label: operatorValues.yes
    })
    allowableOperators.push({
      operator: key,
      type,
      value: `!${key}`,
      label: operatorValues.no
    })
  })

  valueControl = formElements.value
  valueControl.addEventListener('change', () => {
    value = JSON.parse(valueControl.value)
    updateConditions(value)
  })


  conditionContainer.parentNode.insertBefore(valueControl, conditionContainer.nextSibling)

  let value = valueControl.value ? JSON.parse(valueControl.value) : valueControl.value

  const updateValueControl = (input) => {
    if (input === 'condition') {
      value = value || {identifier: '', operator: ''}
      input = JSON.stringify(value, null, 2)
    } else {
      value = undefined
    }
    valueControl.value = input
  }

  const booleanConditionalNodeList = formElements.booleanConditionalOptions
  
  let typeValue = typeof value === 'boolean' ? value.toString() : 'condition'
  if (typeof value === 'boolean') {
    value = undefined
  }

  booleanConditionalNodeList.value = typeValue

  booleanConditional.classList.remove('js-hidden')

  for (let index = 0; index < 3; index++) {
    booleanConditionalNodeList.item(index).addEventListener('change', function() {
      updateValueControl(this.value)
      updateConditions(value)
    })
  }

  if (typeof value === 'object') {
    updateConditions(value)
  }
//})()

</script>

{% endblock %}